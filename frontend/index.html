<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitalTime - 환자 전원 시스템</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-slow {
            0%, 100% {
                background-color: rgb(254 242 242);
                border-color: rgb(252 165 165);
            }
            50% {
                background-color: rgb(254 226 226);
                border-color: rgb(248 113 113);
            }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Map component styles */
        .hospital-map-app {
            display: flex;
            height: 600px; /* Adjust height as needed */
            width: 100%;
        }
        .hospital-map-container {
            flex: 1;
            position: relative;
        }
        .hospital-map {
            height: 100%;
            width: 100%;
        }
        .hospital-sidebar {
            width: 400px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        .hospital-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }
        .hospital-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        .hospital-distance-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .hospital-distance-btn {
            padding: 8px 16px;
            border: 2px solid #333;
            background: white;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .hospital-distance-btn:hover {
            background: #f0f0f0;
        }
        .hospital-distance-btn.active {
            background: #333;
            color: white;
        }
        .hospital-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .hospital-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .hospital-item:hover {
            background-color: #f9f9f9;
        }
        .hospital-checkbox {
            margin-right: 15px;
            width: 18px;
            height: 18px;
            accent-color: #333;
        }
        .hospital-info {
            flex: 1;
        }
        .hospital-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .hospital-address {
            font-size: 14px;
            color: #666;
            margin-bottom: 2px;
        }
        .hospital-distance {
            font-size: 12px;
            color: #888;
        }
        .hospital-phone {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }
        .hospital-loading, .hospital-no-hospitals {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .hospital-stats {
            padding: 15px 20px;
            background: #f9f9f9;
            border-top: 1px solid #e0e0e0;
            font-size: 14px;
            color: #666;
        }
        .hospital-selected-count {
            font-weight: 600;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="config.js"></script>
    <script>
        axios.defaults.baseURL = (window.APP_CONFIG && window.APP_CONFIG.API_BASE_URL) || '';

        function initVueApp() {
            const { createApp, ref, onMounted, onUnmounted, computed } = Vue;
            const { createRouter, createWebHashHistory, useRoute, useRouter } = VueRouter;

            const AppHeader = {
                template: `
                    <div class="bg-blue-100 p-6">
                        <div class="max-w-7xl mx-auto">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h1 class="text-3xl font-bold text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" @click="goHome">VitalTime</h1>
                                </div>
                                <slot></slot>
                            </div>
                        </div>
                    </div>
                `,
                setup() {
                    const router = useRouter();
                    const goHome = () => {
                        router.push('/dashboard');
                    };
                    return { goHome };
                }
            };

            const Map = {
                template: `
                  <div class="hospital-map-app">
                    <div class="hospital-map-container">
                      <div id="hospital-map" class="hospital-map"></div>
                    </div>
                    
                    <div class="hospital-sidebar">
                      <div class="hospital-header">
                        <h1 class="hospital-title">병원 검색</h1>
                        <div class="hospital-distance-buttons">
                          <button 
                            v-for="distance in distances" 
                            :key="distance"
                            :class="['hospital-distance-btn', { active: selectedDistance === distance }]"
                            @click="selectDistance(distance)"
                          >
                            {{ distance }}km
                          </button>
                        </div>
                      </div>
                      
                      <div class="hospital-list">
                        <div v-if="loading" class="hospital-loading">
                          병원을 검색 중입니다...
                        </div>
                        <div v-else-if="filteredHospitals.length === 0" class="hospital-no-hospitals">
                          선택한 반경 내에 병원이 없습니다.
                        </div>
                        <div v-else>
                          <div 
                            v-for="hospital in filteredHospitals" 
                            :key="hospital.id"
                            class="hospital-item"
                            @click="toggleHospital(hospital.id)"
                          >
                            <input 
                              type="checkbox" 
                              class="hospital-checkbox"
                              :checked="selectedHospitals.includes(hospital.id)"
                              @click.stop="toggleHospital(hospital.id)"
                            >
                            <div class="hospital-info">
                              <div class="hospital-name">{{ hospital.name }}</div>
                              <div class="hospital-address">{{ hospital.address }}</div>
                              <div class="hospital-distance">{{ hospital.distance }}km</div>
                              <div class="hospital-phone">{{ hospital.phone }}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="hospital-stats">
                        선택된 병원: <span class="hospital-selected-count">{{ selectedHospitals.length }}</span>개 / 
                        전체: {{ filteredHospitals.length }}개
                      </div>
                    </div>
                  </div>
                `,
                setup(props, { emit }) {
                    const map = ref(null);
                    const userMarker = ref(null);
                    const circle = ref(null);
                    const circles = ref([]);
                    const hospitalMarkers = ref([]);
                    const userLocation = ref(null);
                    const selectedDistance = ref(3);
                    const distances = ref([3, 5, 10, 20]);
                    const selectedHospitals = ref([]);
                    const loading = ref(false);
                    const hospitals = ref([
                        { id: 1, name: "서울대학교병원", address: "서울특별시 종로구 대학로 101", lat: 37.5665, lng: 126.9780, distance: 2.3, phone: "02-2072-2114" },
                        { id: 2, name: "삼성서울병원", address: "서울특별시 강남구 일원로 81", lat: 37.4881, lng: 127.0856, distance: 1.8, phone: "02-3410-2114" },
                        { id: 3, name: "세브란스병원", address: "서울특별시 서대문구 연세로 50-1", lat: 37.5623, lng: 126.9408, distance: 3.2, phone: "02-2228-5800" },
                        { id: 4, name: "고려대학교안암병원", address: "서울특별시 성북구 고려대로 73", lat: 37.5893, lng: 127.0263, distance: 4.1, phone: "02-920-5114" },
                        { id: 5, name: "한양대학교병원", address: "서울특별시 성동구 왕십리로 222-1", lat: 37.5583, lng: 127.0440, distance: 2.7, phone: "02-2290-8114" },
                        { id: 6, name: "서울아산병원", address: "서울특별시 송파구 올림픽로43길 88", lat: 37.5267, lng: 127.1108, distance: 6.8, phone: "02-3010-3114" },
                        { id: 7, name: "중앙대학교병원", address: "서울특별시 동작구 흑석로 102", lat: 37.5068, lng: 126.9590, distance: 5.2, phone: "02-6299-1114" },
                        { id: 8, name: "경희대학교병원", address: "서울특별시 동대문구 경희대로 23", lat: 37.5946, lng: 127.0526, distance: 3.9, phone: "02-958-8114" }
                    ]);

                    const filteredHospitals = computed(() => {
                        return hospitals.value.filter(hospital => hospital.distance <= selectedDistance.value);
                    });

                    const calculateHospitalCenter = () => {
                        const totalLat = hospitals.value.reduce((sum, hospital) => sum + hospital.lat, 0);
                        const totalLng = hospitals.value.reduce((sum, hospital) => sum + hospital.lng, 0);
                        userLocation.value = {
                            lat: totalLat / hospitals.value.length,
                            lng: totalLng / hospitals.value.length
                        };
                    };

                    const updateCircle = () => {
                        circles.value.forEach(c => c.setMap(null));
                        circles.value = [];
                        if (circle.value) {
                            circle.value.setMap(null);
                            circle.value = null;
                        }
                        circle.value = new google.maps.Circle({
                            map: map.value,
                            center: userLocation.value,
                            radius: selectedDistance.value * 1000,
                            fillColor: "#000000",
                            fillOpacity: 0.1,
                            strokeColor: "#000000",
                            strokeOpacity: 0.6,
                            strokeWeight: 2,
                        });
                        circles.value.push(circle.value);
                    };

                    const addHospitalMarkers = () => {
                        if (hospitalMarkers.value) {
                            hospitalMarkers.value.forEach(marker => marker.setMap(null));
                        }
                        hospitalMarkers.value = [];
                        filteredHospitals.value.forEach(hospital => {
                            const marker = new google.maps.Marker({
                                position: { lat: hospital.lat, lng: hospital.lng },
                                map: map.value,
                                title: hospital.name,
                                icon: {
                                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                                    scaledSize: new google.maps.Size(30, 30)
                                }
                            });
                            const infoWindow = new google.maps.InfoWindow({
                                content: `<div style="padding: 10px;"><h3 style="margin: 0 0 5px 0; color: #333;">${hospital.name}</h3><p style="margin: 0; color: #666; font-size: 14px;">${hospital.address}</p><p style="margin: 5px 0 0 0; color: #888; font-size: 12px;">거리: ${hospital.distance}km</p></div>`
                            });
                            marker.addListener('click', () => infoWindow.open(map.value, marker));
                            hospitalMarkers.value.push(marker);
                        });
                    };
                    
                    const setupMap = () => {
                        map.value = new google.maps.Map(document.getElementById("hospital-map"), {
                            center: userLocation.value,
                            zoom: 14,
                        });
                        userMarker.value = new google.maps.Marker({
                            position: userLocation.value,
                            map: map.value,
                            title: "병원 중심점",
                            icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                        });
                        updateCircle();
                        addHospitalMarkers();
                    };

                    const selectDistance = (distance) => {
                        selectedDistance.value = distance;
                        updateCircle();
                        addHospitalMarkers();
                    };

                    const toggleHospital = (hospitalId) => {
                        const index = selectedHospitals.value.indexOf(hospitalId);
                        if (index > -1) {
                            selectedHospitals.value.splice(index, 1);
                        } else {
                            selectedHospitals.value.push(hospitalId);
                        }
                        const selectedData = hospitals.value.filter(h => selectedHospitals.value.includes(h.id));
                        emit('selection-change', selectedData);
                    };

                    const initMap = () => {
                        calculateHospitalCenter();
                        setupMap();
                    };

                    onMounted(() => {
                        initMap();
                    });

                    return {
                        loading,
                        distances,
                        selectedDistance,
                        filteredHospitals,
                        selectedHospitals,
                        selectDistance,
                        toggleHospital
                    };
                }
            };

            const PatientList = {
                components: { AppHeader },
                template: `
                    <div class="min-h-screen bg-gray-50">
                        <app-header>
                            <div class="w-1/3">
                                <div class="flex gap-2">
                                    <select
                                        id="patientSelect"
                                        v-model="selectedPatientName"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                        <option value="">환자 선택...</option>
                                        <option
                                            v-for="patient in patientList"
                                            :key="patient.id"
                                            :value="patient.name"
                                        >
                                            {{ patient.name }}
                                        </option>
                                    </select>
                                    <button
                                        @click="searchPatient"
                                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors whitespace-nowrap"
                                        :disabled="!selectedPatientName"
                                    >
                                        검색
                                    </button>
                                </div>
                            </div>
                        </app-header>

                        <!-- Start Time Banner -->
                        <div v-if="systemStartTime" class="max-w-6xl mx-auto px-6 pt-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg px-4 py-2 flex items-center gap-2 text-sm text-green-800">
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span class="font-medium">AIops 실행 중</span>
                                <span class="text-green-600">|</span>
                                <span>실행 시작 시간: {{ systemStartTime }}</span>
                            </div>
                        </div>

                        <!-- Patient Cards Section -->
                        <div class="max-w-6xl mx-auto p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div
                                    v-for="patient in displayedPatients"
                                    :key="patient.id"
                                    @click="goToPatientDetail(patient.id)"
                                    class="rounded-lg border shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer"
                                    :class="patient.predictedSeverity >= 8 ? 'bg-red-50 border-red-300 animate-pulse-slow' : 'bg-white border-gray-200'"
                                >
                                    <div class="space-y-3">
                                        <div class="flex items-center gap-2">
                                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                {{ patient.id }}
                                            </span>
                                            <span class="text-sm text-gray-900 font-semibold">{{ patient.name }}</span>
                                        </div>
                                        <div class="mt-4 pt-4 border-t border-gray-100 space-y-3">
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm text-gray-500">현재 중증도</span>
                                                <div class="flex items-center">
                                                    <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                                        <div
                                                            :class="getSeverityBarClass(patient.currentSeverity)"
                                                            class="h-2 rounded-full transition-all duration-300"
                                                            :style="'width: ' + (patient.currentSeverity / 10) * 100 + '% '"
                                                        ></div>
                                                    </div>
                                                    <span class="text-sm font-medium text-gray-700">
                                                        {{ patient.currentSeverity }}/10
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm text-gray-500">1분 뒤 예측 중증도</span>
                                                <div class="flex items-center">
                                                    <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                                        <div
                                                            :class="getSeverityBarClass(patient.predictedSeverity)"
                                                            class="h-2 rounded-full transition-all duration-300"
                                                            :style="'width: ' + (patient.predictedSeverity / 10) * 100 + '% '"
                                                        ></div>
                                                    </div>
                                                    <span class="text-sm font-medium text-gray-700">
                                                        {{ patient.predictedSeverity }}/10
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div v-if="displayedPatients.length === 0 && !loading" class="text-center py-12">
                                <div class="text-gray-400 text-lg mb-2">검색된 환자가 없습니다</div>
                                <div class="text-gray-500 text-sm">검색 조건을 다시 확인해주세요</div>
                            </div>

                            <!-- Loading State -->
                            <div v-if="loading" class="text-center py-12">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                                <div class="text-gray-500 text-sm mt-2">환자 정보를 불러오는 중...</div>
                            </div>
                        </div>

                        <!-- 하단 고정 버튼들 -->
                        <div class="fixed bottom-8 right-8 flex flex-col gap-3 items-end">
                            <button
                                @click="openDataViewer"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-lg hover:shadow-xl transition-all flex items-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                데이터 확인하기
                            </button>
                            <button
                                @click="goToMonitoring"
                                class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 shadow-lg hover:shadow-xl transition-all flex items-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                                AI 상태 대시보드
                            </button>
                            <button
                                @click="stopSystem"
                                :disabled="stopping"
                                class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 shadow-lg hover:shadow-xl transition-all flex items-center gap-2 disabled:opacity-50"
                            >
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                                </svg>
                                {{ stopping ? '종료 중...' : 'AIops 실행 종료' }}
                            </button>
                        </div>

                        <!-- 데이터 확인 모달 -->
                        <div v-if="showDataViewer" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                            <div class="bg-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] flex flex-col">
                                <div class="flex items-center justify-between px-6 py-4 border-b">
                                    <h2 class="text-xl font-bold text-gray-800">Clinical Data</h2>
                                    <div class="flex items-center gap-4">
                                        <span v-if="clinicalStats" class="text-sm text-gray-500">
                                            총 {{ clinicalStats.total_records }}건 · 환자 {{ clinicalStats.unique_patients }}명
                                        </span>
                                        <button @click="showDataViewer = false" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                                    </div>
                                </div>
                                <div class="overflow-auto flex-1 px-6 py-4">
                                    <div v-if="dataLoading" class="flex justify-center py-12">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                    </div>
                                    <table v-else class="w-full text-sm border-collapse">
                                        <thead class="sticky top-0 bg-gray-50">
                                            <tr>
                                                <th class="px-3 py-2 text-left border-b font-semibold text-gray-600">Patient</th>
                                                <th class="px-3 py-2 text-left border-b font-semibold text-gray-600">Timestamp</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">TP</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">Creatinine</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">Hemoglobin</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">LDH</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">Lymphocytes</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">Neutrophils</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">Platelet</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">WBC</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">hs-CRP</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">D-Dimer</th>
                                                <th class="px-3 py-2 text-right border-b font-semibold text-gray-600">NEWS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="row in clinicalData" :key="row.clinical_id" class="hover:bg-gray-50 border-b border-gray-100">
                                                <td class="px-3 py-2 text-gray-800">{{ row.patient_id }}</td>
                                                <td class="px-3 py-2 text-gray-500 text-xs">{{ formatTs(row.timestamp) }}</td>
                                                <td class="px-3 py-2 text-right text-gray-600">{{ row.timepoint }}</td>
                                                <td class="px-3 py-2 text-right">{{ row.creatinine ?? '-' }}</td>
                                                <td class="px-3 py-2 text-right">{{ row.hemoglobin ?? '-' }}</td>
                                                <td class="px-3 py-2 text-right">{{ row.ldh ?? '-' }}</td>
                                                <td class="px-3 py-2 text-right">{{ row.lymphocytes ?? '-' }}</td>
                                                <td class="px-3 py-2 text-right">{{ row.neutrophils ?? '-' }}</td>
                                                <td class="px-3 py-2 text-right">{{ row.platelet_count ?? '-' }}</td>
                                                <td class="px-3 py-2 text-right">{{ row.wbc_count ?? '-' }}</td>
                                                <td class="px-3 py-2 text-right">{{ row.hs_crp ?? '-' }}</td>
                                                <td class="px-3 py-2 text-right">{{ row.d_dimer ?? '-' }}</td>
                                                <td class="px-3 py-2 text-right font-semibold" :class="row.news_score >= 7 ? 'text-red-600' : row.news_score >= 4 ? 'text-yellow-600' : 'text-green-600'">{{ row.news_score ?? '-' }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                setup() {
                    const router = useRouter();
                    const patientList = ref([]);
                    const displayedPatients = ref([]);
                    const selectedPatientName = ref('');
                    const loading = ref(false);

                    const getPatientInfoList = async () => {
                        try {
                            loading.value = true;
                            const timestamp = new Date().toISOString();
                            const response = await axios.get('/api/get-patient-info', {
                                params: { timestamp }
                            });
                            const data = response.data;
                            return (data.patients || []).map(p => ({
                                id: p.patient_id, // Use correct patient_id for navigation
                                name: p.patient_name,
                                currentSeverity: p.cur_news || 0,
                                predictedSeverity: p.cur_predicted || 0
                            }));
                        } catch (error) {
                            console.error('Error fetching patient list:', error);
                            return []; // Return empty on error
                        } finally {
                            loading.value = false;
                        }
                    };

                    const getPatientInfo = async (name) => {
                        // This function can also be updated to filter from the full list if needed
                        // For now, we refetch and filter, which is less efficient but works
                        const allPatients = await getPatientInfoList();
                        return allPatients.filter(patient => patient.name === name);
                    };

                    const loadAllPatients = async () => {
                        const patients = await getPatientInfoList();
                        patientList.value = patients;
                        displayedPatients.value = sortPatients(patients);
                        setTimeout(() => {
                            announceCriticalPatients(patients);
                        }, 500);
                    };

                    const sortPatients = (patients) => {
                        return [...patients].sort((a, b) => {
                            if (b.currentSeverity !== a.currentSeverity) {
                                return b.currentSeverity - a.currentSeverity;
                            }
                            if (b.predictedSeverity !== a.predictedSeverity) {
                                return b.predictedSeverity - a.predictedSeverity;
                            }
                            return a.id.toString().localeCompare(a.id.toString());
                        });
                    };

                    const searchPatient = async () => {
                        if (!selectedPatientName.value) {
                            displayedPatients.value = sortPatients(patientList.value);
                            return;
                        }
                        const results = await getPatientInfo(selectedPatientName.value);
                        displayedPatients.value = sortPatients(results);
                    };

                    const formatTimestamp = (timestamp) => {
                        if (!timestamp) return '-'

                        try {
                            const date = new Date(timestamp)
                            const year = date.getFullYear()
                            const month = String(date.getMonth() + 1).padStart(2, '0')
                            const day = String(date.getDate()).padStart(2, '0')
                            const hours = String(date.getHours()).padStart(2, '0')
                            const minutes = String(date.getMinutes()).padStart(2, '0')
                            const seconds = String(date.getSeconds()).padStart(2, '0')

                            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
                        } catch (err) {
                            return timestamp
                        }
                    }

                    const getSeverityBadgeClass = (score) => {
                        if (score >= 7) return 'bg-red-100 text-red-800';
                        if (score >= 4) return 'bg-yellow-100 text-yellow-800';
                        return 'bg-green-100 text-green-800';
                    };

                    const getSeverityBarClass = (score) => {
                        if (score >= 7) return 'bg-red-500';
                        if (score >= 4) return 'bg-yellow-500';
                        return 'bg-green-500';
                    };

                    const goToPatientDetail = (patientId) => {
                        const patient = displayedPatients.value.find(p => p.id === patientId);
                        router.push({
                            name: 'PatientDetail',
                            query: { id: patientId },
                            state: {
                                patientName: patient?.name || '',
                                currentSeverity: patient?.currentSeverity || 0
                            }
                        });
                    };

                    const announceCriticalPatients = (patients) => {
                        const criticalPatients = patients.filter(p => p.predictedSeverity >= 8);
                        if (criticalPatients.length === 0 || !('speechSynthesis' in window)) {
                            return;
                        }

                        const patientNames = criticalPatients.map(p => p.name).join(', ');
                        const message = `긴급, ${patientNames} 님이 1분 뒤 예측 중증도 위험합니다.`;

                        const playSequence = () => {
                            window.speechSynthesis.cancel();
                            let repeats = 0;
                            
                            const play = () => {
                                if (repeats >= 2) return;
                                repeats++;
                                
                                const utterance = new SpeechSynthesisUtterance(message);
                                
                                const koreanVoice = window.speechSynthesis.getVoices().find(v => v.lang === 'ko-KR' || v.lang.startsWith('ko'));
                                if (koreanVoice) utterance.voice = koreanVoice;
                                utterance.lang = 'ko-KR';
                                utterance.rate = 0.9;
                                
                                utterance.onstart = () => {
                                    console.log(`TTS 재생 중 (${repeats}/2):`, message);
                                };
                                utterance.onend = () => {
                                    if (repeats < 2) {
                                        setTimeout(play, 1000);
                                    }
                                };
                                utterance.onerror = (e) => {
                                    console.error("TTS 재생 오류 (반복 중):", e);
                                };
                                
                                window.speechSynthesis.speak(utterance);
                            };
                            
                            play();
                        };

                        const attemptAutoplay = () => {
                            const tester = new SpeechSynthesisUtterance(' ');
                            tester.volume = 0;
                            
                            tester.onend = () => {
                                console.log("TTS 자동재생 가능. 긴급 알림을 재생합니다.");
                                playSequence();
                            };
                            
                            tester.onerror = () => {
                                console.warn('TTS 자동재생이 차단되었습니다. 페이지와 상호작용 후 재시도됩니다.');
                                const retryHandler = () => {
                                    console.log("사용자 상호작용 감지. TTS 재생을 시작합니다.");
                                    playSequence();
                                };
                                window.addEventListener('click', retryHandler, { once: true });
                                window.addEventListener('keydown', retryHandler, { once: true });
                            };
                            
                            window.speechSynthesis.speak(tester);
                        };
                        
                        if (window.speechSynthesis.getVoices().length === 0) {
                            window.speechSynthesis.addEventListener('voiceschanged', attemptAutoplay, { once: true });
                        } else {
                            attemptAutoplay();
                        }
                    };

                    onMounted(() => {
                        loadAllPatients();
                    });

                    onUnmounted(() => {
                        window.speechSynthesis.cancel();
                    });

                    const goToMonitoring = () => {
                        window.location.href = '/monitoring.html';
                    };

                    // 데이터 확인하기
                    const showDataViewer = ref(false);
                    const clinicalData = ref([]);
                    const clinicalStats = ref(null);
                    const dataLoading = ref(false);

                    const openDataViewer = async () => {
                        showDataViewer.value = true;
                        dataLoading.value = true;
                        try {
                            const res = await axios.get('/api/clinical-data');
                            clinicalData.value = res.data.data || [];
                            clinicalStats.value = res.data.statistics || null;
                        } catch (e) {
                            console.error('데이터 조회 실패:', e);
                            clinicalData.value = [];
                        } finally {
                            dataLoading.value = false;
                        }
                    };

                    const formatTs = (ts) => {
                        if (!ts) return '-';
                        return ts.replace('T', ' ').substring(0, 19);
                    };

                    // 시스템 시작 시간
                    const route = useRoute();
                    const systemStartTime = ref('');
                    const stopping = ref(false);

                    const formatStartTime = (isoStr) => {
                        if (!isoStr) return '';
                        const d = new Date(isoStr);
                        return d.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    };

                    if (route.query.startTime) {
                        systemStartTime.value = formatStartTime(route.query.startTime);
                    }

                    const stopSystem = async () => {
                        if (!confirm('VitalTime AIops를 종료하시겠습니까?\n데이터와 학습이 모두 초기화됩니다.')) return;
                        stopping.value = true;
                        try {
                            await axios.post('/api/system/stop');
                            router.replace('/');
                        } catch (e) {
                            alert('시스템 종료에 실패했습니다.');
                            stopping.value = false;
                        }
                    };

                    return {
                        patientList,
                        displayedPatients,
                        selectedPatientName,
                        loading,
                        searchPatient,
                        getSeverityBadgeClass,
                        getSeverityBarClass,
                        goToPatientDetail,
                        formatTimestamp,
                        goToMonitoring,
                        showDataViewer,
                        clinicalData,
                        clinicalStats,
                        dataLoading,
                        openDataViewer,
                        formatTs,
                        systemStartTime,
                        stopping,
                        stopSystem
                    };
                }
            };

            const PatientDetail = {
                components: { Map, AppHeader },
                template: `
                    <div>
                        <app-header></app-header>

                        <!-- Loading State -->
                        <div v-if="loading" class="flex justify-center items-center h-screen">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <div class="text-gray-500 text-xl">데이터 로딩 중...</div>
                            </div>
                        </div>

                        <div v-else class="bg-gray-100 p-4 md:p-8">
                            <div class="max-w-7xl mx-auto">
                                <div class="flex flex-col lg:flex-row gap-6">
                                    <!-- Left Column (1/3) - Scrollable -->
                                    <div class="w-full lg:w-1/3">
                                        <div class="bg-white border border-gray-200 shadow-md rounded-lg p-6 max-h-screen overflow-y-auto">
                                            <h2 class="text-xl font-bold mb-6 text-gray-800">환자 정보</h2>

                                            <!-- Basic Info Section -->
                                            <div class="space-y-3 mb-6">
                                                <div class="flex justify-between py-2">
                                                    <span class="text-gray-600">환자 ID</span>
                                                    <span class="text-gray-900 font-medium">{{ patientInfo.id || '-' }}</span>
                                                </div>

                                                <div class="flex justify-between py-2">
                                                    <span class="text-gray-600">환자명</span>
                                                    <span class="text-gray-900 font-medium">{{ patientInfo.name || '-' }}</span>
                                                </div>

                                                <div class="flex justify-between py-2">
                                                    <span class="text-gray-600">입원 날짜</span>
                                                    <span class="text-gray-900 font-medium">{{ patientInfo.admitDate || '-' }}</span>
                                                </div>

                                                <div class="flex justify-between py-2">
                                                    <span class="text-gray-600">검사 시간</span>
                                                    <span class="text-gray-900 font-medium">{{ patientInfo.testTime || '-' }}</span>
                                                </div>
                                            </div>

                                            <!-- Blood/Lab Indicators Section -->
                                            <div class="border-t border-gray-200 pt-4 mb-6">
                                                <h3 class="text-sm font-bold text-gray-700 mb-3">혈액/검사 지표</h3>
                                                <div class="space-y-4">
                                                    <div>
                                                        <div class="flex justify-between py-1">
                                                            <span class="text-gray-600">Creatinine (크레아티닌)</span>
                                                            <span class="text-gray-900 font-medium">{{ patientInfo.creatinine || 0 }} mg/dL</span>
                                                        </div>
                                                        <div class="text-xs text-gray-500">(신장 기능)</div>
                                                    </div>

                                                    <div>
                                                        <div class="flex justify-between py-1">
                                                            <span class="text-gray-600">Hemoglobin (헤모글로빈)</span>
                                                            <span class="text-gray-900 font-medium">{{ patientInfo.hemoglobin || 0 }} g/dL</span>
                                                        </div>
                                                        <div class="text-xs text-gray-500">(빈혈, 산소 운반)</div>
                                                    </div>

                                                    <div>
                                                        <div class="flex justify-between py-1">
                                                            <span class="text-gray-600">LDH (젖산 탈수소효소)</span>
                                                            <span class="text-gray-900 font-medium">{{ patientInfo.ldh || 0 }} U/L</span>
                                                        </div>
                                                        <div class="text-xs text-gray-500">(조직 손상, 염증)</div>
                                                    </div>

                                                    <div>
                                                        <div class="flex justify-between py-1">
                                                            <span class="text-gray-600">Lymphocytes (림프구)</span>
                                                            <span class="text-gray-900 font-medium">{{ patientInfo.lymphocytes || 0 }}%</span>
                                                        </div>
                                                        <div class="text-xs text-gray-500">(면역 상태)</div>
                                                    </div>

                                                    <div>
                                                        <div class="flex justify-between py-1">
                                                            <span class="text-gray-600">Neutrophils (호중구)</span>
                                                            <span class="text-gray-900 font-medium">{{ patientInfo.neutrophils || 0 }}%</span>
                                                        </div>
                                                        <div class="text-xs text-gray-500">(급성 감염, 염증)</div>
                                                    </div>

                                                    <div>
                                                        <div class="flex justify-between py-1">
                                                            <span class="text-gray-600">Platelet Count (혈소판)</span>
                                                            <span class="text-gray-900 font-medium">{{ patientInfo.platelet_count || 0 }} /μL</span>
                                                        </div>
                                                        <div class="text-xs text-gray-500">(혈액 응고)</div>
                                                    </div>

                                                    <div>
                                                        <div class="flex justify-between py-1">
                                                            <span class="text-gray-600">WBC Count (백혈구)</span>
                                                            <span class="text-gray-900 font-medium">{{ patientInfo.wbc_count || 0 }} /μL</span>
                                                        </div>
                                                        <div class="text-xs text-gray-500">(감염, 염증)</div>
                                                    </div>

                                                    <div>
                                                        <div class="flex justify-between py-1">
                                                            <span class="text-gray-600">hs-CRP</span>
                                                            <span class="text-gray-900 font-medium">{{ patientInfo.hs_crp || 0 }} mg/L</span>
                                                        </div>
                                                        <div class="text-xs text-gray-500">(미세 염증 반응)</div>
                                                    </div>

                                                    <div>
                                                        <div class="flex justify-between py-1">
                                                            <span class="text-gray-600">D-Dimer (D-이합체)</span>
                                                            <span class="text-gray-900 font-medium">{{ patientInfo.d_dimer || 0 }} μg/mL</span>
                                                        </div>
                                                        <div class="text-xs text-gray-500">(혈전증 위험)</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column (2/3) -->
                                    <div class="w-full lg:w-2/3 space-y-6">
                                        <!-- Heart Rate and Severity Grid -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <!-- Left: Predicted Severity -->
                                            <div class="bg-white border-2 shadow-md rounded-lg p-6">
                                                <div class="text-center">
                                                    <div class="text-gray-600 text-sm mb-2">1분 뒤 예측 중증도</div>
                                                    <div class="text-6xl font-bold" :class="getSeverityColor(predictedSeverity)">
                                                        {{ predictedSeverity !== null ? predictedSeverity : '-' }}
                                                    </div>
                                                    <div class="text-gray-500 text-sm mt-2">(1-10 범위)</div>
                                                </div>
                                            </div>

                                            <!-- Right: Real-time Heart Rate -->
                                            <div class="bg-white border-2 shadow-md rounded-lg p-6">
                                                <div class="flex items-center justify-between mb-4">
                                                    <h3 class="text-lg font-semibold text-gray-700">실시간 심박수</h3>
                                                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                                </div>

                                                <div class="text-center">
                                                    <div class="text-5xl font-bold mb-2" :class="getHeartRateColor(heartRate)">
                                                        {{ heartRate }}
                                                    </div>
                                                    <div class="text-gray-500 text-sm">BPM</div>
                                                </div>

                                                <div class="mt-4 text-xs text-gray-400 text-center">
                                                    {{ lastUpdate }}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Nearby Hospitals Map -->
                                        <div class="bg-white border border-gray-200 shadow-md rounded-lg">
                                            <Map @selection-change="onHospitalSelectionChange"></Map>
                                        </div>

                                        <!-- Patient Transfer Button -->
                                        <button
                                            @click="createTransferManual"
                                            :disabled="selectedHospitals.length === 0"
                                            class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed transition-colors"
                                        >
                                            {{ buttonText }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                setup() {
                    const route = useRoute();
                    const router = useRouter();
                    const loading = ref(false);
                    const patientId = ref('');
                    const patientInfo = ref({
                        id: '',
                        name: '',
                        admitDate: '',
                        testTime: '',
                        creatinine: 0,
                        hemoglobin: 0,
                        ldh: 0,
                        lymphocytes: 0,
                        neutrophils: 0,
                        platelet_count: 0,
                        wbc_count: 0,
                        hs_crp: 0,
                        d_dimer: 0
                    });
                    const predictedSeverity = ref(null);
                    const selectedHospitals = ref([]);

                    // 심박수 모니터링
                    const heartRate = ref(90);
                    const lastUpdate = ref('');
                    let heartRateInterval = null;

                    const onHospitalSelectionChange = (selection) => {
                        selectedHospitals.value = selection;
                    };

                    const buttonText = computed(() => {
                        const count = selectedHospitals.value.length;
                        if (count === 0) {
                            return '환자 이송 매뉴얼 생성';
                        }
                        return `${count}개의 병원에 전송할 환자 이송 매뉴얼 생성`;
                    });

                    const getSeverityColor = (score) => {
                        if (!score) return 'text-gray-400';
                        if (score >= 7) return 'text-red-600';
                        if (score >= 4) return 'text-yellow-600';
                        return 'text-green-600';
                    };

                    const getHeartRateColor = (bpm) => {
                        if (bpm < 60) return 'text-blue-600';     // 서맥
                        if (bpm > 100) return 'text-red-600';     // 빈맥
                        return 'text-green-600';                  // 정상
                    };

                    const updateHeartRate = () => {
                        const change = Math.floor(Math.random() * 7) - 3;  // -3 ~ +3
                        const newRate = heartRate.value + change;
                        heartRate.value = Math.max(80, Math.min(100, newRate));
                        lastUpdate.value = new Date().toLocaleTimeString('ko-KR');
                    };

                    const formatDate = (timestamp) => {
                        if (!timestamp) return '-';
                        const date = new Date(timestamp);
                        return date.toISOString().split('T')[0]; // YYYY-MM-DD 형식
                    };

                    const formatDateTime = (timestamp) => {
                        if (!timestamp) return '-';
                        const date = new Date(timestamp);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        const seconds = String(date.getSeconds()).padStart(2, '0');
                        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                    };

                    const fetchPatientData = async () => {
                        try {
                            loading.value = true;

                            // 현재 timestamp (또는 고정된 테스트 timestamp)
                            const currentTimestamp = new Date().toISOString();

                            console.log('=== API 호출 시작 ===');
                            console.log('환자 ID:', patientId.value);
                            console.log('Timestamp:', currentTimestamp);

                            // 1. 환자 기본 정보 가져오기 (cur_predicted 포함)
                            const patientInfoResponse = await axios.get('/api/get-patient-info', {
                                params: { timestamp: currentTimestamp }
                            });
                            const patientInfoData = patientInfoResponse.data;
                            const currentPatient = (patientInfoData.patients || []).find(
                                p => p.patient_id === parseInt(patientId.value)
                            );

                            console.log('환자 기본 정보:', currentPatient);

                            // 2. 환자 상세 데이터 가져오기
                            console.log('요청 URL:', `/api/get-patient-data-range/${patientId.value}`);
                            const response = await axios.get(
                                `/api/get-patient-data-range/${patientId.value}`,
                                {
                                    params: { timestamp: currentTimestamp }
                                }
                            );

                            console.log('=== API 응답 성공 ===');
                            console.log('응답 상태:', response.status);
                            console.log('응답 데이터:', response.data);

                            const responseData = response.data;

                            if (responseData.data && responseData.data.length > 0) {
                                const latestData = responseData.data[0]; // 가장 최근 데이터
                                console.log('최신 데이터:', latestData);

                                // 환자 정보 매핑
                                patientInfo.value = {
                                    id: `P${String(latestData.patient_id).padStart(3, '0')}`,
                                    name: currentPatient?.patient_name || patientInfo.value.name || '환자명 없음',
                                    admitDate: formatDate(latestData.timestamp),
                                    testTime: formatDateTime(latestData.timestamp),

                                    // 의료 데이터
                                    creatinine: latestData.creatinine,
                                    hemoglobin: latestData.hemoglobin,
                                    ldh: latestData.ldh,
                                    lymphocytes: latestData.lymphocytes,
                                    neutrophils: latestData.neutrophils,
                                    platelet_count: latestData.platelet_count,
                                    wbc_count: latestData.wbc_count,
                                    hs_crp: latestData.hs_crp,
                                    d_dimer: latestData.d_dimer
                                };

                                // 8시간 후 예측 중증도 (첫 페이지와 동일하게 cur_predicted 사용)
                                predictedSeverity.value = currentPatient?.cur_predicted || 0;

                                console.log('매핑된 환자 정보:', patientInfo.value);
                                console.log('예측 중증도 (cur_predicted):', predictedSeverity.value);
                            } else {
                                console.warn('응답 데이터가 비어있습니다.');
                            }

                        } catch (error) {
                            console.error('=== API 에러 발생 ===');
                            console.error('에러 객체:', error);
                            console.error('에러 메시지:', error.message);

                            if (error.response) {
                                // 서버가 응답을 반환한 경우
                                console.error('응답 상태 코드:', error.response.status);
                                console.error('응답 헤더:', error.response.headers);
                                console.error('응답 데이터:', error.response.data);
                                console.error('응답 데이터 상세:', JSON.stringify(error.response.data, null, 2));
                            } else if (error.request) {
                                // 요청이 전송되었지만 응답을 받지 못한 경우
                                console.error('요청 객체:', error.request);
                                console.error('응답을 받지 못했습니다.');
                            } else {
                                // 요청 설정 중 에러가 발생한 경우
                                console.error('요청 설정 에러:', error.message);
                            }
                            console.error('에러 설정:', error.config);
                            console.error(`\n💥 환자 데이터 로드 실패\n상태: ${error.response?.status || 'Unknown'}\n메시지: ${error.response?.data?.detail || error.message}`);
                        } finally {
                            loading.value = false;
                            console.log('=== API 호출 종료 ===');
                        }
                    };

                    const createTransferManual = () => {
                        if (selectedHospitals.value.length === 0) {
                            alert('최소 1개 이상의 병원을 선택해주세요');
                            return;
                        }

                        // 전달할 데이터 준비 (순수 JSON만 포함)
                        const transferData = {
                            patientId: patientInfo.value.id,
                            patientName: patientInfo.value.name,
                            severity: predictedSeverity.value,
                            medicalData: {
                                d_dimer: patientInfo.value.d_dimer,
                                ldh: patientInfo.value.ldh,
                                creatinine: patientInfo.value.creatinine,
                                hemoglobin: patientInfo.value.hemoglobin,
                                lymphocytes: patientInfo.value.lymphocytes,
                                neutrophils: patientInfo.value.neutrophils,
                                platelet_count: patientInfo.value.platelet_count,
                                wbc_count: patientInfo.value.wbc_count,
                                hs_crp: patientInfo.value.hs_crp
                            },
                            timestamp: patientInfo.value.testTime || new Date().toLocaleString('ko-KR'),
                            // 선택된 병원 정보 (순수 객체만 전달)
                            selectedHospitals: selectedHospitals.value.map(h => ({
                                id: h.id,
                                name: h.name,
                                address: h.address,
                                distance: h.distance,
                                phone: h.phone
                            }))
                        };

                        console.log('전달할 데이터:', transferData);

                        // 페이지 이동 (state로 데이터 전달)
                        router.push({
                            name: 'PatientReport',
                            state: transferData
                        });
                    };

                    onMounted(async () => {
                        // URL에서 환자 ID 가져오기
                        patientId.value = route.query.id || '1';

                        // 심박수 모니터링 시작
                        updateHeartRate();
                        heartRateInterval = setInterval(updateHeartRate, 2000);

                        // 이전 페이지에서 전달받은 환자 정보
                        const routerState = window.history.state;
                        if (routerState && routerState.patientName) {
                            patientInfo.value.name = routerState.patientName;
                        }

                        await fetchPatientData();
                    });

                    onUnmounted(() => {
                        if (heartRateInterval) {
                            clearInterval(heartRateInterval);
                        }
                    });

                    return {
                        loading,
                        patientInfo,
                        predictedSeverity,
                        selectedHospitals,
                        heartRate,
                        lastUpdate,
                        getSeverityColor,
                        getHeartRateColor,
                        createTransferManual,
                        onHospitalSelectionChange,
                        buttonText
                    };
                }
            };

            const PatientReport = {
                components: { AppHeader },
                template: `
                    <div class="min-h-screen bg-gray-50">
                        <!-- Header -->
                        <AppHeader />

                        <!-- Main Content -->
                        <div class="max-w-7xl mx-auto p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                                <!-- Left Column: Patient & Hospital Info (40%) -->
                                <div class="lg:col-span-2 space-y-6">
                                    <!-- Patient Information Card -->
                                    <div class="bg-white rounded-lg border border-gray-200 shadow-md">
                                        <div class="px-6 py-4 border-b border-gray-200">
                                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                                <svg class="h-5 w-5 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                </svg>
                                                환자 정보
                                            </h3>
                                        </div>
                                        <div class="px-6 py-4 space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">환자명</label>
                                                <div class="mt-1 text-lg font-semibold text-gray-900">{{ patientInfo?.name || '-' }}</div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">환자 ID</label>
                                                <div class="mt-1 text-gray-900">{{ patientInfo?.id || '-' }}</div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">중증도</label>
                                                <div class="mt-1">
                                                    <span
                                                        :class="getSeverityBadgeClass(patientInfo?.severity)"
                                                        class="px-3 py-1 rounded-full text-sm font-medium"
                                                    >
                                                        {{ getSeverityText(patientInfo?.severity) || '-' }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Hospital Information Card -->
                                    <div class="bg-white rounded-lg border border-gray-200 shadow-md">
                                        <div class="px-6 py-4 border-b border-gray-200">
                                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                                <svg class="h-5 w-5 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h4M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                                </svg>
                                                이송 병원 정보
                                            </h3>
                                        </div>
                                        <div class="px-6 py-4 space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">병원명</label>
                                                <div class="mt-1 text-lg font-semibold text-gray-900">{{ hospitalInfo?.name || '-' }}</div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">주소</label>
                                                <div class="mt-1 text-gray-900">{{ hospitalInfo?.address || '-' }}</div>
                                            </div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700">거리</label>
                                                    <div class="mt-1 text-gray-900">{{ hospitalInfo?.distance || '-' }}km</div>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700">연락처</label>
                                                    <div class="mt-1 text-gray-900">{{ hospitalInfo?.phone || '-' }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Clinical Data Card -->
                                    <div class="bg-white rounded-lg border border-gray-200 shadow-md">
                                        <div class="px-6 py-4 border-b border-gray-200">
                                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                                <svg class="h-5 w-5 text-purple-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                                </svg>
                                                최신 검사 수치
                                            </h3>
                                        </div>
                                        <div class="px-6 py-4 space-y-4">
                                            <div class="grid grid-cols-1 gap-4">
                                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                                    <span class="text-sm font-medium text-gray-700">D-Dimer</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.d_dimer || 0 }} μg/mL
                                                    </span>
                                                </div>
                                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                                    <span class="text-sm font-medium text-gray-700">LDH</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.ldh || 0 }} U/L
                                                    </span>
                                                </div>
                                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                                    <span class="text-sm font-medium text-gray-700">Creatinine</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.creatinine || 0 }} mg/dL
                                                    </span>
                                                </div>
                                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                                    <span class="text-sm font-medium text-gray-700">Hemoglobin</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.hemoglobin || 0 }} g/dL
                                                    </span>
                                                </div>
                                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                                    <span class="text-sm font-medium text-gray-700">Lymphocytes</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.lymphocytes || 0 }}%
                                                    </span>
                                                </div>
                                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                                    <span class="text-sm font-medium text-gray-700">Neutrophils</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.neutrophils || 0 }}%
                                                    </span>
                                                </div>
                                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                                    <span class="text-sm font-medium text-gray-700">Platelet Count</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.platelet_count || 0 }} /μL
                                                    </span>
                                                </div>
                                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                                    <span class="text-sm font-medium text-gray-700">WBC Count</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.wbc_count || 0 }} /μL
                                                    </span>
                                                </div>
                                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                                    <span class="text-sm font-medium text-gray-700">hs-CRP</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.hs_crp || 0 }} mg/L
                                                    </span>
                                                </div>
                                                <div class="flex justify-between items-center py-2">
                                                    <span class="text-sm font-medium text-gray-700">검사 시점</span>
                                                    <span class="text-sm font-semibold text-gray-900">
                                                        {{ patientInfo?.testTime || '-' }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column: AI Report (60%) -->
                                <div class="lg:col-span-3">
                                    <div class="bg-white rounded-lg border border-gray-200 shadow-md h-full">
                                        <div class="px-6 py-4 border-b border-gray-200">
                                            <div class="flex items-center justify-between">
                                                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                                    <svg class="h-5 w-5 text-orange-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                    </svg>
                                                    AI 생성 환자 전원 의뢰서
                                                </h3>
                                                <span v-if="!reportLoading" class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">
                                                    자동 생성됨
                                                </span>
                                            </div>
                                        </div>
                                        <div class="px-6 py-4">
                                            <!-- 로딩 상태 -->
                                            <div v-if="reportLoading" class="flex flex-col items-center justify-center py-20 min-h-[600px]">
                                                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-600 mb-4"></div>
                                                <p class="text-gray-600 text-lg font-semibold">보고서를 생성하고 있습니다...</p>
                                                <p class="text-gray-400 text-sm mt-2">AI가 환자 정보를 분석 중입니다</p>
                                            </div>

                                            <!-- 보고서 내용 -->
                                            <div v-else class="bg-gray-50 rounded-lg p-4 min-h-[600px] font-mono text-sm leading-relaxed whitespace-pre-line overflow-auto border" style="font-family: 'Courier New', monospace;">
                                                {{ aiReport?.report_content || '보고서 내용이 없습니다.' }}
                                            </div>

                                            <div v-if="aiReport?.generated_at && !reportLoading" class="mt-3 text-xs text-gray-500 text-right">
                                                생성 시간: {{ formatDateTime(aiReport.generated_at) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="mt-8 flex justify-center space-x-4">
                                <button
                                    @click="printReport"
                                    :disabled="reportLoading"
                                    class="px-6 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors"
                                    :class="reportLoading ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500'"
                                >
                                    <svg class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                    </svg>
                                    보고서 출력
                                </button>
                                <button
                                    @click="downloadReport"
                                    :disabled="reportLoading"
                                    class="px-6 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors"
                                    :class="reportLoading ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700 focus:ring-green-500'"
                                >
                                    <svg class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    다운로드
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                setup() {
                    const route = useRoute();
                    const router = useRouter();
                    const reportLoading = ref(true);
                    const patientInfo = ref(null);
                    const hospitalInfo = ref(null);
                    const aiReport = ref(null);

                    const mockPatients = {
                        'P001': { id: 'P001', name: '김민수', admitDate: '2025-09-30', testTime: '2025-09-30 06:30:00', creatinine: 1.2, hemoglobin: 13.5, ldh: 250, lymphocytes: 25.3, neutrophils: 68.5, platelet_count: 180000, wbc_count: 8500, hs_crp: 5.2, d_dimer: 0.8, severity: 8, predictedAt: '2025-09-30 14:32:15' },
                        'P002': { id: 'P002', name: '이수현', admitDate: '2025-09-30', testTime: '2025-09-30 07:15:00', creatinine: 0.9, hemoglobin: 14.2, ldh: 220, lymphocytes: 30.1, neutrophils: 65.2, platelet_count: 200000, wbc_count: 7200, hs_crp: 3.1, d_dimer: 0.5, severity: 3, predictedAt: '2025-09-30 15:18:10' },
                        'P003': { id: 'P003', name: '박지영', admitDate: '2025-09-30', testTime: '2025-09-30 16:45:00', creatinine: 1.5, hemoglobin: 11.8, ldh: 310, lymphocytes: 18.5, neutrophils: 75.3, platelet_count: 150000, wbc_count: 11000, hs_crp: 8.7, d_dimer: 1.2, severity: 9, predictedAt: '2025-10-01 00:45:23' },
                        'P004': { id: 'P004', name: '정우진', admitDate: '2025-09-30', testTime: '2025-09-30 17:20:00', creatinine: 1.1, hemoglobin: 13.9, ldh: 240, lymphocytes: 28.5, neutrophils: 66.8, platelet_count: 190000, wbc_count: 8200, hs_crp: 4.5, d_dimer: 0.7, severity: 5, predictedAt: '2025-10-01 01:20:45' },
                        'P005': { id: 'P005', name: '최은비', admitDate: '2025-09-30', testTime: '2025-09-30 18:00:00', creatinine: 0.8, hemoglobin: 14.8, ldh: 200, lymphocytes: 32.5, neutrophils: 62.1, platelet_count: 220000, wbc_count: 6800, hs_crp: 2.3, d_dimer: 0.4, severity: 2, predictedAt: '2025-10-01 02:00:12' },
                        'P006': { id: 'P006', name: '강동현', admitDate: '2025-09-30', testTime: '2025-09-30 19:15:00', creatinine: 1.4, hemoglobin: 12.3, ldh: 290, lymphocytes: 20.5, neutrophils: 72.8, platelet_count: 160000, wbc_count: 10500, hs_crp: 7.8, d_dimer: 1.1, severity: 7, predictedAt: '2025-10-01 03:15:33' },
                        'P007': { id: 'P007', name: '윤서영', admitDate: '2025-09-30', testTime: '2025-09-30 20:30:00', creatinine: 1.0, hemoglobin: 13.6, ldh: 235, lymphocytes: 27.2, neutrophils: 67.5, platelet_count: 185000, wbc_count: 8000, hs_crp: 4.1, d_dimer: 0.6, severity: 4, predictedAt: '2025-10-01 04:30:54' },
                        'P008': { id: 'P008', name: '임준호', admitDate: '2025-09-30', testTime: '2025-09-30 21:00:00', creatinine: 1.3, hemoglobin: 12.9, ldh: 270, lymphocytes: 22.8, neutrophils: 70.5, platelet_count: 170000, wbc_count: 9500, hs_crp: 6.5, d_dimer: 0.9, severity: 6, predictedAt: '2025-10-01 05:00:28' },
                        'P009': { id: 'P009', name: '한소미', admitDate: '2025-09-30', testTime: '2025-09-30 22:10:00', creatinine: 0.9, hemoglobin: 14.5, ldh: 210, lymphocytes: 31.2, neutrophils: 63.5, platelet_count: 210000, wbc_count: 7000, hs_crp: 2.8, d_dimer: 0.5, severity: 1, predictedAt: '2025-10-01 06:10:17' }
                    };

                    const mockHospitals = {
                        1: { id: 1, name: "서울대학교병원", address: "서울특별시 종로구 대학로 101", lat: 37.5665, lng: 126.9780, distance: 2.3, phone: "02-2072-2114" },
                        2: { id: 2, name: "삼성서울병원", address: "서울특별시 강남구 일원로 81", lat: 37.4881, lng: 127.0856, distance: 1.8, phone: "02-3410-2114" },
                        3: { id: 3, name: "세브란스병원", address: "서울특별시 서대문구 연세로 50-1", lat: 37.5623, lng: 126.9408, distance: 3.2, phone: "02-2228-5800" },
                        4: { id: 4, name: "고려대학교안암병원", address: "서울특별시 성북구 고려대로 73", lat: 37.5893, lng: 127.0263, distance: 4.1, phone: "02-920-5114" },
                        5: { id: 5, name: "한양대학교병원", address: "서울특별시 성동구 왕십리로 222-1", lat: 37.5583, lng: 127.0440, distance: 2.7, phone: "02-2290-8114" },
                        6: { id: 6, name: "서울아산병원", address: "서울특별시 송파구 올림픽로43길 88", lat: 37.5267, lng: 127.1108, distance: 6.8, phone: "02-3010-3114" },
                        7: { id: 7, name: "중앙대학교병원", address: "서울특별시 동작구 흑석로 102", lat: 37.5068, lng: 126.9590, distance: 5.2, phone: "02-6299-1114" },
                        8: { id: 8, name: "경희대학교병원", address: "서울특별시 동대문구 경희대로 23", lat: 37.5946, lng: 127.0526, distance: 3.9, phone: "02-958-8114" }
                    };

                    const generateAIReport = async () => {
                        reportLoading.value = true;
                        try {
                            console.log('=== AI 보고서 생성 시작 (로컬 모델) ===');

                            // 백엔드 API 호출 (로컬 모델)
                            const response = await axios.post('/api/generate-transfer-report', {
                                patientName: patientInfo.value.name,
                                patientId: patientInfo.value.id,
                                severity: patientInfo.value.severity,
                                testTime: patientInfo.value.testTime,
                                hospitalName: hospitalInfo.value.name,
                                hospitalAddress: hospitalInfo.value.address,
                                hospitalPhone: hospitalInfo.value.phone,
                                medicalData: {
                                    d_dimer: patientInfo.value.d_dimer,
                                    ldh: patientInfo.value.ldh,
                                    creatinine: patientInfo.value.creatinine,
                                    hemoglobin: patientInfo.value.hemoglobin,
                                    lymphocytes: patientInfo.value.lymphocytes,
                                    neutrophils: patientInfo.value.neutrophils,
                                    platelet_count: patientInfo.value.platelet_count,
                                    wbc_count: patientInfo.value.wbc_count,
                                    hs_crp: patientInfo.value.hs_crp
                                }
                            });

                            console.log('AI 생성 보고서 (로컬):', response.data);

                            aiReport.value = {
                                report_content: response.data.report_content,
                                generated_at: response.data.generated_at
                            };

                            console.log('=== AI 보고서 생성 완료 (로컬) ===');
                            reportLoading.value = false;

                        } catch (error) {
                            console.error('=== 로컬 모델 실패, page3 API 호출 시도 ===');
                            console.error('로컬 모델 에러:', error);

                            try {
                                // page3 API 호출
                                console.log('page3 API로 보고서 생성 시도...');

                                const selectedHospital = hospitalInfo.value.name && hospitalInfo.value.name !== '-'
                                    ? hospitalInfo.value
                                    : { name: '미지정', address: '미지정', distance: 0, phone: '미지정', id: 0 };

                                const page3RequestData = {
                                    patient_id: parseInt(patientInfo.value.id.toString().replace('P', '')) || 0,
                                    hospital_info: {
                                        id: selectedHospital.id || 0,
                                        name: selectedHospital.name,
                                        address: selectedHospital.address,
                                        distance: parseFloat(selectedHospital.distance) || 0.0,
                                        phone: selectedHospital.phone
                                    }
                                };

                                console.log('page3 API 요청 데이터:', page3RequestData);

                                const page3Response = await axios.post('/api/page3/patient-report', page3RequestData);

                                console.log('page3 API 응답:', page3Response.data);

                                aiReport.value = {
                                    report_content: page3Response.data.ai_report.report_content,
                                    generated_at: page3Response.data.ai_report.generated_at
                                };

                                console.log('=== page3 API로 보고서 생성 완료 ===');
                                reportLoading.value = false;

                            } catch (page3Error) {
                                console.error('=== page3 API도 실패, 기본 템플릿 사용 ===');
                                console.error('page3 에러:', page3Error);

                                // 두 API 모두 실패 시 기본 템플릿 사용
                                aiReport.value = {
                                    report_content: `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
환자 전원 의뢰서
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 환자 기본 정보
 • 성명: ${patientInfo.value.name}
 • 환자번호: ${patientInfo.value.id}
 • 중증도 분류: ${getSeverityText(patientInfo.value.severity)}

■ 이송 의료기관
 • 기관명: ${hospitalInfo.value.name}
 • 소재지: ${hospitalInfo.value.address}
 • 연락처: ${hospitalInfo.value.phone}

■ 현재 상태 및 검사 소견
 • 주요 검사 결과:
   - D-Dimer: ${patientInfo.value.d_dimer} μg/mL
   - LDH: ${patientInfo.value.ldh} U/L
   - Creatinine: ${patientInfo.value.creatinine} mg/dL
   - Hemoglobin: ${patientInfo.value.hemoglobin} g/dL
   - Lymphocytes: ${patientInfo.value.lymphocytes}%
   - Neutrophils: ${patientInfo.value.neutrophils}%
   - Platelet Count: ${patientInfo.value.platelet_count} /μL
   - WBC Count: ${patientInfo.value.wbc_count} /μL
   - hs-CRP: ${patientInfo.value.hs_crp} mg/L

■ 전원 사유 및 임상적 판단
환자의 검사 수치를 종합적으로 검토한 결과, 전문적인 중환자 치료가 필요한
상태로 판단되어 상급 의료기관으로의 전원을 권고합니다.

■ 특이사항 및 주의사항
이송 중 활력징후 모니터링이 필수이며, 필요 시 응급 처치를 준비해주시기 바랍니다.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

※ AI 보고서 생성 실패로 기본 템플릿을 사용했습니다.`,
                                    generated_at: new Date().toISOString()
                                };
                                reportLoading.value = false;
                            }
                        }
                    };

                    const fetchPatientReport = async () => {
                        console.log('=== PatientReport 데이터 수신 ===');
                        console.log('window.history.state:', window.history.state);

                        // window.history.state에서 전달받은 데이터 가져오기
                        const receivedData = window.history.state;

                        if (receivedData && receivedData.patientId) {
                            console.log('전달받은 데이터:', receivedData);

                            // 환자 정보 즉시 설정 (로딩 없음)
                            patientInfo.value = {
                                id: receivedData.patientId,
                                name: receivedData.patientName,
                                severity: receivedData.severity,
                                d_dimer: receivedData.medicalData?.d_dimer || 0,
                                ldh: receivedData.medicalData?.ldh || 0,
                                creatinine: receivedData.medicalData?.creatinine || 0,
                                hemoglobin: receivedData.medicalData?.hemoglobin || 0,
                                lymphocytes: receivedData.medicalData?.lymphocytes || 0,
                                neutrophils: receivedData.medicalData?.neutrophils || 0,
                                platelet_count: receivedData.medicalData?.platelet_count || 0,
                                wbc_count: receivedData.medicalData?.wbc_count || 0,
                                hs_crp: receivedData.medicalData?.hs_crp || 0,
                                testTime: receivedData.timestamp
                            };

                            // 병원 정보 즉시 설정 (로딩 없음)
                            if (receivedData.selectedHospitals && receivedData.selectedHospitals.length > 0) {
                                hospitalInfo.value = receivedData.selectedHospitals[0];
                            } else {
                                hospitalInfo.value = { id: 0, name: '-', address: '-', distance: '-', phone: '-' };
                            }

                            console.log('환자 정보 설정 완료:', patientInfo.value);

                            // AI 보고서 생성 (비동기, 별도 로딩)
                            await generateAIReport();
                        } else {
                            console.error('전달받은 데이터가 없습니다.');
                            alert('환자 정보가 없습니다.');
                            router.back();
                        }
                    };

                    const getSeverityBadgeClass = (severity) => {
                        if (severity >= 7) return 'bg-red-100 text-red-800';
                        if (severity >= 4) return 'bg-yellow-100 text-yellow-800';
                        return 'bg-green-100 text-green-800';
                    };

                    const getSeverityText = (severity) => {
                        if (severity >= 7) return '중증';
                        if (severity >= 4) return '중등도';
                        return '경증';
                    };

                    const formatDateTime = (dateString) => {
                        const date = new Date(dateString);
                        return date.toLocaleString('ko-KR');
                    };

                    const goBack = () => {
                        router.back();
                    };

                    const printReport = () => {
                        window.print();
                    };

                    const downloadReport = () => {
                        const content = aiReport.value?.report_content || '';
                        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `전원의뢰서_${patientInfo.value?.name || 'unknown'}_${new Date().toISOString().split('T')[0]}.txt`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    };

                    onMounted(() => {
                        fetchPatientReport();
                    });

                    return {
                        reportLoading,
                        patientInfo,
                        hospitalInfo,
                        aiReport,
                        getSeverityBadgeClass,
                        getSeverityText,
                        formatDateTime,
                        goBack,
                        printReport,
                        downloadReport
                    };
                }
            };

            // ====================================
            // 랜딩 페이지 (시스템 시작/대기)
            // ====================================
            const LandingPage = {
                template: `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 flex items-center justify-center">
                        <div class="text-center max-w-lg mx-auto p-8">
                            <div class="mb-8">
                                <div class="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                    <svg class="w-7 h-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                                    </svg>
                                </div>
                                <h1 class="text-2xl font-bold text-gray-900 mb-2">VitalTime</h1>
                                <p class="text-sm text-gray-500">AIops 실시간 환자 모니터링 시스템</p>
                            </div>

                            <div v-if="error" class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                                {{ error }}
                            </div>

                            <button
                                v-if="!starting"
                                @click="startSystem"
                                class="px-6 py-3 bg-blue-600 text-white text-sm font-semibold rounded-xl hover:bg-blue-700 shadow-lg hover:shadow-xl transition-all transform hover:scale-105"
                            >
                                VitalTime AIops 실행
                            </button>

                            <div v-if="starting" class="space-y-4">
                                <div class="flex items-center justify-center gap-3">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                    <span class="text-gray-700 font-medium">시스템 시작 중...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                setup() {
                    const router = useRouter();
                    const starting = ref(false);
                    const error = ref('');

                    const checkStatus = async () => {
                        try {
                            const res = await axios.get('/api/system/status');
                            if (res.data.running) {
                                router.replace({ name: 'PatientList', query: { startTime: res.data.start_time } });
                            }
                        } catch (e) {}
                    };

                    const startSystem = async () => {
                        starting.value = true;
                        error.value = '';
                        try {
                            const res = await axios.post('/api/system/start');
                            router.replace({ name: 'PatientList', query: { startTime: res.data.start_time } });
                        } catch (e) {
                            error.value = '시스템 시작에 실패했습니다. 다시 시도해주세요.';
                            starting.value = false;
                        }
                    };

                    onMounted(checkStatus);

                    return { starting, error, startSystem };
                }
            };

            const router = createRouter({
                history: createWebHashHistory(),
                routes: [
                    { path: '/', name: 'Landing', component: LandingPage },
                    { path: '/dashboard', name: 'PatientList', component: PatientList },
                    { path: '/detail', name: 'PatientDetail', component: PatientDetail },
                    { path: '/patient-report', name: 'PatientReport', component: PatientReport }
                ]
            });

            const app = createApp({
                template: '<router-view></router-view>'
            });

            app.use(router);
            app.mount('#app');
        }

        // Load Google Maps and then initialize the Vue app
        function loadGoogleMaps() {
            const apiKey = (window.APP_CONFIG && window.APP_CONFIG.GOOGLE_MAPS_API_KEY) ? window.APP_CONFIG.GOOGLE_MAPS_API_KEY : '';
            if (apiKey && apiKey !== 'YOUR_API_KEY_HERE') {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initVueApp`;
                script.onerror = () => alert('Google Maps 스크립트를 불러오는 데 실패했습니다. API 키를 확인해주세요.');
                document.head.appendChild(script);
            } else {
                console.warn("Google Maps API 키가 설정되지 않았습니다. config.js 파일을 확인해주세요. 지도 기능 없이 앱을 실행합니다.");
                initVueApp(); // Run the app without maps if no key is provided
            }
        }

        loadGoogleMaps();
    </script>
</body>
</html>